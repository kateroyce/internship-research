---
title: "Varying parameters"
author: "Kate Royce"
date: "4/27/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(metaflu)
library(ggplot2)
library(dplyr)
library(doMC)
library(tidyr)
library(purrr)
library(gridExtra)
library(abind)
registerDoMC(cores = 20)
library(doRNG)
set.seed(123)

```

#Introduction
This experiment varies parameters $\omega$, $\pi$, and t-detect to investigate how outbreak severity (measured by duration and spread) depends on each.

``` {r param-setup}
farm_number <- 100

parms = list(
  beta = 1.44456,   #contact rate for direct transmission
  gamma = 0.167,  #recovery rate
  mu = 0,         #base mortality rate
  alpha = 0.4,      #disease mortality rate
  phi = 0,  #infectiousness of environmental virions
  eta = 0,     #degradation rate of environmental virions
  nu =  0.00,    #uptake rate of environmental virion
  sigma = 0,      #virion shedding rate
  omega = 0.03,   #movement rate (look at varying this too--inversely dependent with farm size)
  rho = 0.85256,        #contact  nonlinearity 0=dens-dependent, 1=freq-dependent
  lambda = 0,     #force of infection from external sources
  tau_crit = 5,   #critical suveillance time
  I_crit = 1,     #threshold for reporting
  pi_report = 1, #reporting probability (vary this too!)
  pi_detect = 1, #detection probability (1 for cleanliness)
  cull_time = 1,   #time to detect, which will be changed in this simulation
  network_type = "smallworld",
  network_parms = list(dim = 1, size = farm_number, nei = 2.33, p = 0.0596, multiple = FALSE, loops = FALSE),
  stochastic_network = TRUE
)

vary_params <- function(param_value, param_vector){
  
  #create list of results for varying the given parameter
  results_list <- lapply(param_vector, function(x){
    parms[[param_value]] <- x
    sims <- 1000
    g_list <- mclapply(seq_len(sims), function(y){
      patches <- grow_patches_clustered(basic_patches(40,100))
      i_patches <- seed_initial_infection(patches)
      return(mf_sim(init = i_patches, parameters = parms, times=1:365, n_sims = 1))
    }, mc.cores = 20)

    return(do.call("abind", g_list))
  })
 

  dlist <- lapply(seq_along(results_list), function(x){
    return(get_duration_array(results_list[[x]]))
  })
  dmeans <- sapply(dlist, function(x) mean(x$duration))
  duration_df <- data.frame(values = param_vector, mean_durations = dmeans)
  duration <- ggplot(data = duration_df) + geom_point(aes(x = values, y = mean_durations)) +
    labs(x = param_value, y = "mean duration") + theme_classic()
  
  plot(duration)
  
  #graph severity of outbreak for each param value
  farm_num <- lapply(results_list, function(x) get_number_farms(x))

  outbreak_list <- unlist(lapply(farm_num, function(x){
    return(sum(x > 5)/length(x)) #changed from >1 farm to >5 because the lowest proportion in the earlier case was still >50%
  }))

  outbreak_df <- data.frame(values = param_vector, props = outbreak_list)
  outbreak <- ggplot(data = outbreak_df) + geom_point(aes(x = values, y = props)) +
    labs(x = param_value, y = "proportion of outbreaks >5 farms")
  plot(outbreak)
  
  #unclutter environment
  rm(results_list)
}
```

##Small farms

In this experiment, the network was 100 farms with 50 chickens each. 

Varying t-detect from 1 to 20 days.

``` {r culling-small}
farm_size <- 50

cull_time_vector <- c(1:20)
vary_params("cull_time", cull_time_vector, sims = 10, farm_number, farm_size, parms)
cull_time <- 1 #reset
```

Varying $\pi$ from 0.1 to 1. $\pi$-report and $\pi$-detect have been condensed to 1 overall probability by setting $\pi$-detect = 1.
``` {r prob-small}
prob_vector <- seq(0.1,1,0.1)
vary_params("pi_report", prob_vector, sims = 10, farm_number, farm_size, parms)
pi_report <- 1 #reset
```

Varying $\omega$ from 0.01 to 0.2, showing a peak at ~0.1.
```{r omega-small}
rate_vector <- seq(0.01,0.2, 0.01)
vary_params("omega", rate_vector, sims = 10, farm_number, farm_size, parms)
omega <- 0.03 #reset
```


#Large farms

In this experiment, the network was 100 farms with 500 chickens each. 

Varying t-detect from 1 to 20 days.

``` {r culling-large}
farm_size <- 500

cull_time_vector <- c(1:20)
vary_params("cull_time", cull_time_vector, sims = 10, farm_number, farm_size, parms)
cull_time <- 1 #reset
```

Varying $\pi$ from 0.1 to 1. $\pi$-report and $\pi$-detect have been condensed to 1 overall probability by setting $\pi$-detect = 1.
``` {r prob-large}
prob_vector <- seq(0.1,1,0.1)
vary_params("pi_report", prob_vector, sims = 10, farm_number, farm_size, parms)
pi_report <- 1 #reset
```

Varying $\omega$ from 0.01 to 0.2, showing a peak at ~0.1.
```{r omega-large}
rate_vector <- seq(0.01,0.2, 0.01)
vary_params("omega", rate_vector, sims = 10, farm_number, farm_size, parms)
omega <- 0.03 #reset
```